package com.gtocore.common.data.machines;

import com.gtocore.api.machine.part.GTOPartAbility;
import com.gtocore.common.data.GTOBlocks;
import com.gtocore.common.data.GTOMaterials;
import com.gtocore.common.data.GTORecipeTypes;
import com.gtocore.common.data.translation.GTOMachineTooltips;
import com.gtocore.common.machine.mana.multiblock.*;

import com.gtolib.GTOCore;
import com.gtolib.api.annotation.NewDataAttributes;
import com.gtolib.api.machine.ManaDistributorMachine;
import com.gtolib.api.machine.MultiblockDefinition;
import com.gtolib.api.recipe.modifier.RecipeModifierFunction;
import com.gtolib.utils.MultiBlockFileReader;
import com.gtolib.utils.RLUtils;
import com.gtolib.utils.RegistriesUtils;

import com.gregtechceu.gtceu.GTCEu;
import com.gregtechceu.gtceu.api.data.chemical.ChemicalHelper;
import com.gregtechceu.gtceu.api.data.tag.TagPrefix;
import com.gregtechceu.gtceu.api.machine.MultiblockMachineDefinition;
import com.gregtechceu.gtceu.api.machine.multiblock.PartAbility;
import com.gregtechceu.gtceu.api.pattern.FactoryBlockPattern;
import com.gregtechceu.gtceu.api.pattern.MultiblockShapeInfo;
import com.gregtechceu.gtceu.api.pattern.util.RelativeDirection;
import com.gregtechceu.gtceu.common.data.GCYMBlocks;
import com.gregtechceu.gtceu.common.data.GTBlocks;
import com.gregtechceu.gtceu.common.data.GTRecipeTypes;

import net.minecraft.world.item.ItemStack;
import net.minecraft.world.level.block.Blocks;

import vazkii.botania.common.block.BotaniaBlocks;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import static com.gregtechceu.gtceu.api.machine.multiblock.PartAbility.*;
import static com.gregtechceu.gtceu.api.pattern.Predicates.*;
import static com.gtocore.api.machine.part.GTOPartAbility.OUTPUT_MANA;
import static com.gtocore.common.data.GTOMaterials.Runerock;
import static com.gtocore.utils.register.MachineRegisterUtils.multiblock;

public final class ManaMultiBlock {

    public static void init() {}

    private static ItemStack[] manaAlloyRewardPool;

    public static final MultiblockMachineDefinition MANA_ALLOY_BLAST_SMELTER = multiblock("mana_alloy_blast_smelter", "魔力合金炉", ManaAlloyBlastSmelterMachine::new)
            .nonYAxisRotation()
            .durationMultiplierTooltips(0.5)
            .tooltipsText("机器需要提供魔力来维持运行", "Machines need to provide mana to maintain working")
            .tooltipsText("每tick消耗的基础量为2^机器等级", "The base consumption per tick is 2^(machine tier)")
            .tooltipsText("机器每运行60秒，需要在10秒内输入一个指定的符文来抑制魔力，否则魔力消耗翻4倍", "Machines need to provide a specified rune in 10 seconds to suppress mana consumption every 60 seconds, otherwise the mana consumption will be multiplied by 4")
            .tooltipsText("需要输入符文时机器会产生对应的红石信号", "Machines will produce corresponding redstone signals when rune is needed")
            .tooltipsText("符文编号：", "Rune number:")
            .tooltipsSupplier(() -> Collections.singletonList(ManaAlloyBlastSmelterMachine.getRunes()))
            .tooltips(NewDataAttributes.ALLOW_PARALLEL_NUMBER.create(16))
            .recipeModifier(RecipeModifierFunction.overclocking(0.5, 1, 0.5))
            .recipeTypes(GTORecipeTypes.ALLOY_BLAST_RECIPES)
            .block(GTOBlocks.MANASTEEL_CASING)
            .pattern(definition -> MultiBlockFileReader.start(definition)
                    .where('A', blocks(RegistriesUtils.getBlock("botania:livingrock")))
                    .where('B', blocks(GTOBlocks.MANASTEEL_CASING.get())
                            .or(autoAbilities(definition.getRecipeTypes()))
                            .or(abilities(GTOPartAbility.INPUT_MANA).setMaxGlobalLimited(8, 1))
                            .or(abilities(MAINTENANCE).setExactLimit(1)))
                    .where('C', blocks(GTOBlocks.MANASTEEL_CASING.get()))
                    .where('D', controller(definition))
                    .where('E', blocks(RegistriesUtils.getBlock("botania:elf_glass")))
                    .where('F', blocks(RegistriesUtils.getBlock("botania:livingrock_wall")))
                    .where('G', blocks(ChemicalHelper.getBlock(TagPrefix.frameGt, GTOMaterials.Gaiasteel)))
                    .where('H', heatingCoils())
                    .where('I', abilities(MUFFLER))
                    .where(' ', any())
                    .build())
            .workableCasingRenderer(GTOCore.id("block/casings/manasteel_casing"), GTCEu.id("block/multiblock/gcym/blast_alloy_smelter"))
            .recoveryStacks((m, r) -> {
                if (manaAlloyRewardPool == null) {
                    manaAlloyRewardPool = new ItemStack[] {
                            ChemicalHelper.get(TagPrefix.dustTiny, GTOMaterials.Salamander),
                            ChemicalHelper.get(TagPrefix.dustTiny, GTOMaterials.Undine),
                            ChemicalHelper.get(TagPrefix.dustTiny, GTOMaterials.Sylph),
                            ChemicalHelper.get(TagPrefix.dustTiny, GTOMaterials.Gnome),
                            ChemicalHelper.get(TagPrefix.dustTiny, Runerock)
                    };
                }
                if (m.getLevel() != null) {
                    return manaAlloyRewardPool[m.getLevel().random.nextInt(manaAlloyRewardPool.length)];
                }
                return manaAlloyRewardPool[0];
            })
            .register();

    public static final MultiblockMachineDefinition BASE_MANA_DISTRIBUTOR = multiblock("base_mana_distributor", "基础魔力分配器", ManaDistributorMachine.create(16, 32))
            .nonYAxisRotation()
            .tooltipsText("自动为附近的魔力机器提供魔力", "Automatically provides mana to nearby mana machines")
            .tooltipsKey("gtocore.machine.maximum_amount", 16)
            .tooltipsKey("gui.ae2.WirelessRange", 8)
            .recipeTypes(GTRecipeTypes.DUMMY_RECIPES)
            .block(RegistriesUtils.getSupplierBlock("botania:livingrock_bricks"))
            .pattern(definition -> MultiBlockFileReader.start(definition)
                    .where('~', controller(definition))
                    .where('A', blocks(RegistriesUtils.getBlock("botania:livingrock_bricks_wall")))
                    .where('B', blocks(RegistriesUtils.getBlock("botania:livingrock_bricks")))
                    .where('b', blocks(RegistriesUtils.getBlock("botania:livingrock_bricks"))
                            .or(abilities(GTOPartAbility.INPUT_MANA))
                            .or(abilities(GTOPartAbility.EXTRACT_MANA)))
                    .where('C', blocks(Blocks.BIRCH_FENCE_GATE))
                    .where('D', blocks(RegistriesUtils.getBlock("botania:livingrock")))
                    .where('E', blocks(RegistriesUtils.getBlock("botania:chiseled_livingrock_bricks")))
                    .where('F', blocks(RegistriesUtils.getBlock("botania:apothecary_livingrock")))
                    .where('G', blocks(RegistriesUtils.getBlock("botania:mana_pool")))
                    .where('H', blocks(RegistriesUtils.getBlock("botania:mana_pylon")))
                    .where('I', blocks(RegistriesUtils.getBlock("botania:mana_glass")))
                    .where(' ', any())
                    .build())
            .workableCasingRenderer(RLUtils.bot("block/livingrock_bricks"), GTOCore.id("block/multiblock/mana"))
            .register();

    public static final MultiblockMachineDefinition ADVANCED_MANA_DISTRIBUTOR = multiblock("advanced_mana_distributor", "进阶魔力分配器", ManaDistributorMachine.create(64, 128))
            .nonYAxisRotation()
            .tooltipsKey("gtocore.machine.base_mana_distributor.tooltip.0")
            .tooltipsKey("gtocore.machine.maximum_amount", 64)
            .tooltipsKey("gui.ae2.WirelessRange", 32)
            .recipeTypes(GTRecipeTypes.DUMMY_RECIPES)
            .block(RegistriesUtils.getSupplierBlock("botania:livingrock_bricks"))
            .pattern(definition -> MultiBlockFileReader.start(definition)
                    .where('~', controller(definition))
                    .where('A', blocks(RegistriesUtils.getBlock("botania:livingrock")))
                    .where('B', blocks(RegistriesUtils.getBlock("botania:livingrock_bricks_wall")))
                    .where('C', blocks(RegistriesUtils.getBlock("botania:livingrock_bricks")))
                    .where('c', blocks(RegistriesUtils.getBlock("botania:livingrock_bricks"))
                            .or(abilities(GTOPartAbility.INPUT_MANA))
                            .or(abilities(GTOPartAbility.EXTRACT_MANA)))
                    .where('D', blocks(RegistriesUtils.getBlock("botania:apothecary_livingrock")))
                    .where('E', blocks(RegistriesUtils.getBlock("botania:mana_pylon")))
                    .where('F', blocks(RegistriesUtils.getBlock("botania:chiseled_livingrock_bricks")))
                    .where('G', blocks(RegistriesUtils.getBlock("botania:mana_glass")))
                    .where('H', blocks(RegistriesUtils.getBlock("botania:mana_pool")))
                    .where('I', blocks(RegistriesUtils.getBlock("botania:natura_pylon")))
                    .where(' ', any())
                    .build())
            .workableCasingRenderer(RLUtils.bot("block/livingrock_bricks"), GTOCore.id("block/multiblock/mana"))
            .register();

    public static final MultiblockMachineDefinition MANA_INFUSER = multiblock("mana_infuser", "魔力灌注机", ManaMultiblockMachine::new)
            .nonYAxisRotation()
            .parallelizableTooltips()
            .perfectOCTooltips()
            .parallelizableManaOverclock()
            .recipeTypes(GTORecipeTypes.MANA_INFUSER_RECIPES)
            .block(GTOBlocks.MANASTEEL_CASING)
            .pattern(definition -> MultiBlockFileReader.start(definition)
                    .where('A', blocks(RegistriesUtils.getBlock("botania:livingrock_bricks_wall")))
                    .where('B', blocks(RegistriesUtils.getBlock("botania:livingrock_bricks")))
                    .where('C', blocks(RegistriesUtils.getBlock("botania:livingwood_fence")))
                    .where('D', blocks(RegistriesUtils.getBlock("botania:livingwood")))
                    .where('E', controller(definition))
                    .where('F', blocks(GTOBlocks.MANASTEEL_CASING.get())
                            .or(abilities(GTOPartAbility.INPUT_MANA).setMaxGlobalLimited(16, 1))
                            .or(abilities(PARALLEL_HATCH).setMaxGlobalLimited(1))
                            .or(abilities(EXPORT_ITEMS).setMaxGlobalLimited(16, 1))
                            .or(abilities(IMPORT_ITEMS).setMaxGlobalLimited(16, 1)))
                    .where('G', blocks(ChemicalHelper.getBlock(TagPrefix.frameGt, GTOMaterials.Manasteel)))
                    .where('H', blocks(RegistriesUtils.getBlock("botania:glimmering_livingwood")))
                    .where('I', blocks(RegistriesUtils.getBlock("botania:mana_glass")))
                    .where('J', blocks(Blocks.AIR))
                    .where('K', blocks(RegistriesUtils.getBlock("botania:mana_distributor")))
                    .where('L', blocks(RegistriesUtils.getBlock("botania:mana_pylon")))
                    .where('M', blocks(GTOBlocks.MANASTEEL_CASING.get()))
                    .where(' ', any())
                    .build())
            .workableCasingRenderer(GTOCore.id("block/casings/manasteel_casing"), GTCEu.id("block/multiblock/gcym/large_chemical_bath"))
            .register();

    public static final MultiblockMachineDefinition MANA_CONDENSER = multiblock("mana_condenser", "魔力凝聚器", ManaCondenserMachine::new)
            .nonYAxisRotation()
            .parallelizableTooltips()
            .perfectOCTooltips()
            .parallelizableManaOverclock()
            .recipeTypes(GTORecipeTypes.MANA_CONDENSER_RECIPES)
            .block(GTOBlocks.MANASTEEL_CASING)
            .pattern(definition -> ManaCondenserMachine.getBlockPattern(0, definition))
            .shapeInfos(definition -> {
                List<MultiblockShapeInfo> shapeInfos = new ArrayList<>();
                for (int i = 0; i < 2; i++) {
                    shapeInfos.addAll(MultiblockDefinition.getMatchingShapes(false, ManaCondenserMachine.getBlockPattern(i, definition)));
                }
                return shapeInfos;
            })
            .workableCasingRenderer(GTOCore.id("block/casings/manasteel_casing"), GTCEu.id("block/multiblock/gcym/large_mixer"))
            .register();

    public static final MultiblockMachineDefinition ELF_EXCHANGE = multiblock("elf_exchange", "精灵交易所", ElfExchangeMachine::new)
            .langValue("ELF Exchange")
            .nonYAxisRotation()
            .parallelizableTooltips()
            .perfectOCTooltips()
            .parallelizableManaOverclock()
            .tooltipsSupplier(GTOMachineTooltips.INSTANCE.getElfExchangeMachine().getSupplier())
            .recipeTypes(GTORecipeTypes.ELF_EXCHANGE_RECIPES)
            .block(GTOBlocks.MANASTEEL_CASING)
            .pattern(definition -> MultiBlockFileReader.start(definition)
                    .where('A', blocks(ChemicalHelper.getBlock(TagPrefix.frameGt, GTOMaterials.Manasteel)))
                    .where('B', blocks(GTOBlocks.MANASTEEL_CASING.get())
                            .or(abilities(GTOPartAbility.INPUT_MANA).setMaxGlobalLimited(2, 1))
                            .or(abilities(PARALLEL_HATCH).setMaxGlobalLimited(1))
                            .or(abilities(EXPORT_ITEMS).setMaxGlobalLimited(4, 1))
                            .or(abilities(IMPORT_ITEMS).setMaxGlobalLimited(4, 1)))
                    .where('C', controller(definition))
                    .where('D', blocks(RegistriesUtils.getBlock("botania:polished_livingrock")))
                    .where('E', blocks(GTOBlocks.MANASTEEL_CASING.get()))
                    .where('F', blocks(RegistriesUtils.getBlock("botania:bifrost_perm")))
                    .where('G', blocks(ChemicalHelper.getBlock(TagPrefix.frameGt, GTOMaterials.Elementium)))
                    .where('H', blocks(RegistriesUtils.getBlock("botania:elf_glass")))
                    .where('I', blocks(RegistriesUtils.getBlock("botania:alfheim_portal")))
                    .where('J', blocks(RegistriesUtils.getBlock("botania:dragonstone_block")))
                    .where(' ', any())
                    .build())
            .workableCasingRenderer(GTOCore.id("block/casings/manasteel_casing"), GTCEu.id("block/multiblock/gcym/large_centrifuge"))
            .register();

    public static final MultiblockMachineDefinition INDUSTRIAL_ALTAR = multiblock("industrial_altar", "工业祭坛", ManaMultiblockMachine::new)
            .nonYAxisRotation()
            .parallelizableTooltips()
            .perfectOCTooltips()
            .parallelizableManaOverclock()
            .recipeTypes(GTORecipeTypes.INDUSTRIAL_ALTAR_RECIPES)
            .block(GTOBlocks.MANASTEEL_CASING)
            .pattern(definition -> MultiBlockFileReader.start(definition, RelativeDirection.FRONT, RelativeDirection.UP, RelativeDirection.RIGHT)
                    .where('A', blocks(GTOBlocks.MANASTEEL_CASING.get())
                            .or(abilities(GTOPartAbility.INPUT_MANA).setMaxGlobalLimited(16, 1))
                            .or(abilities(PARALLEL_HATCH).setMaxGlobalLimited(1))
                            .or(abilities(IMPORT_FLUIDS).setMaxGlobalLimited(16, 1))
                            .or(abilities(EXPORT_ITEMS).setMaxGlobalLimited(16, 1))
                            .or(abilities(IMPORT_ITEMS).setMaxGlobalLimited(16, 1)))
                    .where('B', blocks(RegistriesUtils.getBlock("botania:livingwood_wall")))
                    .where('C', blocks(RegistriesUtils.getBlock("botania:apothecary_livingrock")))
                    .where('D', blocks(Blocks.LANTERN))
                    .where('E', blocks(RegistriesUtils.getBlock("botania:livingwood_fence")))
                    .where('G', blocks(GTOBlocks.MANASTEEL_CASING.get()))
                    .where('H', blocks(RegistriesUtils.getBlock("botania:livingrock_bricks")))
                    .where('I', blocks(RegistriesUtils.getBlock("botania:glimmering_livingwood")))
                    .where('J', controller(definition))
                    .where('K', blocks(RegistriesUtils.getBlock("botania:runic_altar")))
                    .where('L', blocks(RegistriesUtils.getBlock("botania:brewery")))
                    .where('M', blocks(ChemicalHelper.getBlock(TagPrefix.block, Runerock)))
                    .where(' ', any())
                    .build())
            .workableCasingRenderer(GTOCore.id("block/casings/manasteel_casing"), GTCEu.id("block/multiblock/gcym/large_centrifuge"))
            .register();

    public static final MultiblockMachineDefinition MANA_GREENHOUSE = multiblock("mana_greenhouse", "魔力温室", ManaEnergyMultiblockMachine::new)
            .nonYAxisRotation()
            .parallelizableTooltips()
            .perfectOCTooltips()
            .recipeTypes(GTORecipeTypes.GREENHOUSE_RECIPES)
            .block(GTOBlocks.MANASTEEL_CASING)
            .pattern(definition -> MultiBlockFileReader.start(definition, RelativeDirection.RIGHT, RelativeDirection.UP, RelativeDirection.BACK)
                    .where('A', blocks(RegistriesUtils.getBlock("botania:livingrock_slab")))
                    .where('C', blocks(GTOBlocks.MANASTEEL_CASING.get()))
                    .where('D', blocks(RegistriesUtils.getBlock("botania:glimmering_livingwood")))
                    .where('E', blocks(RegistriesUtils.getBlock("botania:livingrock_bricks")))
                    .where('F', blocks(RegistriesUtils.getBlock("botania:mana_glass")))
                    .where('G', blocks(Blocks.AIR))
                    .where('H', blocks(ChemicalHelper.getBlock(TagPrefix.frameGt, GTOMaterials.Gaiasteel)))
                    .where('I', blocks(RegistriesUtils.getBlock("botania:livingrock_bricks_wall")))
                    .where('J', blocks(BotaniaBlocks.enchantedSoil))
                    .where('K', blocks(GTOBlocks.MANASTEEL_CASING.get())
                            .or(abilities(GTOPartAbility.INPUT_MANA).setMaxGlobalLimited(16, 1))
                            .or(abilities(PARALLEL_HATCH).setMaxGlobalLimited(1))
                            .or(abilities(IMPORT_FLUIDS).setMaxGlobalLimited(4, 1))
                            .or(abilities(EXPORT_ITEMS).setMaxGlobalLimited(4, 1))
                            .or(abilities(IMPORT_ITEMS).setMaxGlobalLimited(4, 1)))
                    .where('L', controller(definition))
                    .where(' ', any())
                    .build())
            .workableCasingRenderer(GTOCore.id("block/casings/manasteel_casing"), GTCEu.id("block/multiblock/gcym/large_centrifuge"))
            .register();

    public static final MultiblockMachineDefinition MANA_GARDEN = multiblock("mana_garden", "魔力花园", ElectricManaMultiblockMachine::new)
            .nonYAxisRotation()
            .parallelizableTooltips()
            .recipeTypes(GTORecipeTypes.MANA_GARDEN_RECIPES, GTORecipeTypes.MANA_GARDEN_FUEL)
            .recipeModifier(RecipeModifierFunction.HATCH_PARALLEL)
            .block(RegistriesUtils.getSupplierBlock("botania:livingrock"))
            .pattern(definition -> MultiBlockFileReader.start(definition, RelativeDirection.FRONT, RelativeDirection.UP, RelativeDirection.RIGHT)
                    .where('A', blocks(RegistriesUtils.getBlock("botania:livingrock")))
                    .where('B', blocks(RegistriesUtils.getBlock("botania:mana_pylon")))
                    .where('C', blocks(RegistriesUtils.getBlock("botania:livingwood")))
                    .where('D', blocks(RegistriesUtils.getBlock("botania:glimmering_livingwood")))
                    .where('E', air())
                    .where('F', blocks(RegistriesUtils.getBlock("botania:livingrock"))
                            .or(abilities(PARALLEL_HATCH).setMaxGlobalLimited(1))
                            .or(abilities(IMPORT_FLUIDS).setMaxGlobalLimited(4, 1))
                            .or(abilities(IMPORT_ITEMS).setMaxGlobalLimited(4, 1))
                            .or(abilities(EXPORT_FLUIDS).setMaxGlobalLimited(4, 1))
                            .or(abilities(INPUT_ENERGY))
                            .or(abilities(OUTPUT_MANA))
                            .or(abilities(MAINTENANCE).setExactLimit(1)))
                    .where('G', blocks(RegistriesUtils.getBlock("botania:livingrock_wall")))
                    .where('H', blocks(RegistriesUtils.getBlock("botania:elf_glass")))
                    .where('I', blocks(RegistriesUtils.getBlock("botania:mana_spreader")))
                    .where('J', blocks(RegistriesUtils.getBlock("botania:enchanted_soil")))
                    .where('K', blocks(RegistriesUtils.getBlock("botania:thermalily")))
                    .where('L', blocks(RegistriesUtils.getBlock("botania:kekimurus")))
                    .where('M', blocks(RegistriesUtils.getBlock("botania:dandelifeon")))
                    .where('N', blocks(RegistriesUtils.getBlock("botania:hydroangeas_motif")))
                    .where('O', blocks(RegistriesUtils.getBlock("botania:dreamwood")))
                    .where('P', blocks(GTOBlocks.MANASTEEL_CASING.get()))
                    .where('Q', controller(definition))
                    .where('R', blocks(RegistriesUtils.getBlock("botania:endoflame")))
                    .where('S', blocks(RegistriesUtils.getBlock("botania:rosa_arcana")))
                    .where('T', blocks(RegistriesUtils.getBlock("botania:entropinnyum")))
                    .where('U', blocks(RegistriesUtils.getBlock("botania:gourmaryllis")))
                    .where('V', blocks(RegistriesUtils.getBlock("botania:spectrolus")))
                    .where('W', blocks(RegistriesUtils.getBlock("botania:shulk_me_not")))
                    .where('X', blocks(RegistriesUtils.getBlock("botania:natura_pylon")))
                    .where('Y', blocks(RegistriesUtils.getBlock("botania:livingwood_log")))
                    .where('Z', blocks(RegistriesUtils.getBlock("botania:munchdew")))
                    .where('[', blocks(RegistriesUtils.getBlock("botania:narslimmus")))
                    .where('a', blocks(RegistriesUtils.getBlock("botania:bellethorn")))
                    .where(' ', any())
                    .build())
            .workableCasingRenderer(RLUtils.bot("block/livingrock"), GTCEu.id("block/multiblock/gcym/large_centrifuge"))
            .register();

    public static final MultiblockMachineDefinition RUNE_ENGRAVING_CHAMBER = multiblock("rune_engraving_chamber", "符文铭刻室", ManaMultiblockMachine::new)
            .nonYAxisRotation()
            .parallelizableTooltips()
            .perfectOCTooltips()
            .parallelizableManaOverclock()
            .recipeTypes(GTORecipeTypes.RUNE_ENGRAVING_RECIPES)
            .block(GTOBlocks.SPELL_PRISM_CASING)
            .pattern(definition -> MultiBlockFileReader.start(definition)
                    .where('A', blocks(GTOBlocks.ALFSTEEL_CASING.get()))
                    .where('B', blocks(GTOBlocks.SPELL_PRISM_CASING.get()))
                    .where('C', blocks(GTOBlocks.SPELL_PRISM_CASING.get())
                            .or(abilities(EXPORT_ITEMS).setMaxGlobalLimited(4, 1))
                            .or(abilities(IMPORT_ITEMS).setMaxGlobalLimited(4, 1))
                            .or(abilities(IMPORT_FLUIDS).setMaxGlobalLimited(4, 1))
                            .or(abilities(GTOPartAbility.INPUT_MANA).setMaxGlobalLimited(16, 1))
                            .or(abilities(PARALLEL_HATCH).setMaxGlobalLimited(1))
                            .or(abilities(MAINTENANCE).setExactLimit(1)))
                    .where('D', blocks(GTOBlocks.ORIGINAL_BRONZE_CASING.get()))
                    .where('E', blocks(RegistriesUtils.getBlock("botania:corporea_block")))
                    .where('F', blocks(GTOBlocks.SOURCE_FIBER_MECHANICAL_CASING.get()))
                    .where('G', blocks(GTOBlocks.INFUSED_GOLD_CASING.get()))
                    .where('H', blocks(RegistriesUtils.getBlock("gtceu:opal_block")))
                    .where('I', blocks(RegistriesUtils.getBlock("botania:mana_glass")))
                    .where('J', blocks(RegistriesUtils.getBlock("ars_nouveau:source_gem_block")))
                    .where('K', blocks(RegistriesUtils.getBlock("gtceu:olivine_block")))
                    .where('L', blocks(RegistriesUtils.getBlock("botania:elf_glass")))
                    .where('M', blocks(RegistriesUtils.getBlock("botania:bifrost_perm")))
                    .where('N', controller(definition))
                    .where(' ', any())
                    .build())
            .workableCasingRenderer(GTOCore.id("block/casings/spell_prism_casing"), GTCEu.id("block/multiblock/gcym/large_centrifuge"))
            .register();

    public static final MultiblockMachineDefinition LARGE_ALCHEMICAL_DEVICE = multiblock("large_alchemical_device", "大型炼金装置", LargeAlchemicalDeviceMachine::new)
            .nonYAxisRotation()
            .parallelizableTooltips()
            .tooltipsSupplier(GTOMachineTooltips.INSTANCE.getAlchemicalDeviceTooltips().getSupplier())
            .tooltipsSupplier(GTOMachineTooltips.INSTANCE.getLargeAlchemicalDeviceTooltips().getSupplier())
            .moduleTooltips(new PartAbility[0])
            .recipeModifiers(RecipeModifierFunction.HATCH_PARALLEL)
            .recipeTypes(GTORecipeTypes.ALCHEMY_CAULDRON_RECIPES)
            .block(GCYMBlocks.CASING_CORROSION_PROOF)
            .pattern(definition -> FactoryBlockPattern.start(definition)
                    .aisle(" AAAAA ", "  BBB  ", "  CCC  ", "  CCC  ", "  CDC  ", "  CDC  ", "  CDC  ", "  CDC  ", "  CDC  ", "  CDC  ", "  CDC  ", "  CCC  ", "  CCC  ", "       ")
                    .aisle("A  B  A", " BEEEB ", " CEEEC ", " C   C ", " C   C ", " C   C ", " C   C ", " C   C ", " C   C ", " C   C ", " C   C ", " C   C ", " CEEEC ", "  BBB  ")
                    .aisle("A EEEAA", "BE   EB", "CE   EC", "C     C", "C     C", "C     C", "C     C", "C     C", "C     C", "C     C", "C     C", "C     C", "CE   EC", " BFFFB ")
                    .aisle("ABEEEBA", "BE G EB", "CE G EC", "C  G  C", "D  G  D", "D  G  D", "D  G  D", "D  G  D", "D  G  D", "D  G  D", "D  G  D", "C  G  C", "CE G EC", " BFIFB ")
                    .aisle("A EEEAA", "BE   EB", "CE   EC", "C     C", "C     C", "C     C", "C     C", "C     C", "C     C", "C     C", "C     C", "C     C", "CE   EC", " BFFFB ")
                    .aisle("A  B  A", " BEEEB ", " CEEEC ", " C   C ", " C   C ", " C   C ", " C   C ", " C   C ", " C   C ", " C   C ", " C   C ", " C   C ", " CEEEC ", "  BBB  ")
                    .aisle(" AAAAA ", "  BBB  ", "  CHC  ", "  CCC  ", "  CDC  ", "  CDC  ", "  CDC  ", "  CDC  ", "  CDC  ", "  CDC  ", "  CDC  ", "  CCC  ", "  CCC  ", "       ")
                    .where('A', blocks(GTOBlocks.PPS_CORROSION_RESISTANT_MECHANICAL_HOUSING.get()))
                    .where('B', blocks(ChemicalHelper.getBlock(TagPrefix.frameGt, GTOMaterials.Herbs)))
                    .where('C', blocks(GCYMBlocks.CASING_CORROSION_PROOF.get())
                            .or(abilities(EXPORT_ITEMS).setMaxGlobalLimited(4, 1))
                            .or(abilities(IMPORT_ITEMS).setMaxGlobalLimited(4, 1))
                            .or(abilities(EXPORT_FLUIDS).setMaxGlobalLimited(4, 1))
                            .or(abilities(IMPORT_FLUIDS).setMaxGlobalLimited(4, 1))
                            .or(abilities(PARALLEL_HATCH).setMaxGlobalLimited(1))
                            .or(abilities(GTOPartAbility.INPUT_MANA).setMaxGlobalLimited(16, 1))
                            .or(abilities(MAINTENANCE).setExactLimit(1)))
                    .where('D', blocks(GTOBlocks.CHEMICAL_GRADE_GLASS.get()))
                    .where('E', blocks(GCYMBlocks.CASING_CORROSION_PROOF.get()))
                    .where('F', blocks(GTBlocks.FILTER_CASING.get()))
                    .where('G', blocks(GTBlocks.HERMETIC_CASING_IV.get()))
                    .where('H', controller(definition))
                    .where('I', blocks(GTOBlocks.IRIDIUM_PIPE_CASING.get()))
                    .where(' ', any())
                    .build())
            .addSubPattern(definition -> FactoryBlockPattern.start(definition)
                    .aisle("      AAA    ", "      CCC    ", "      CEC    ", "      CEC    ", "      CCC    ", "             ", "             ", "             ", "             ", "             ", "      FFF    ", "      FEF    ", "      FEF    ", "      FFF    ", "      AAA    ", "             ")
                    .aisle("     AAAAAAA ", "     CCDCC A ", "     C   C A ", "     C   C A ", "     CCICC A ", "       I   A ", "       I   A ", "       I   A ", "       I   A ", "       I   A ", "     FFIFF A ", "     FF FF A ", "     FF FF A ", "     FFDFF A ", "AAAAAAAAAAAA ", "             ")
                    .aisle("     AAAAAAAA", "     CDGDDBAA", "     E H EBAA", "     E H EBAA", "     CGHGCBAA", "      GJG BAA", "      GJG BAA", "      GJG BAA", "      GJG BAA", "      GJG BAA", "     FGHGFBAA", "     E H EBAA", "     E H EBAA", "     FDGDDBAA", "ADDAAAAAAAAAA", " AAAAAAAAAAA ")
                    .aisle("     AAAAAAA ", "     CCDCC A ", "     C   C A ", "     C   C A ", "     CCICC A ", "       I   A ", "       I   A ", "       I   A ", "       I   A ", "       I   A ", "     FFIFF A ", "     FF FF A ", "     FF FF A ", "     FFDFF A ", "AAAAAAAAAAAA ", "             ")
                    .aisle("      AAA    ", "      CCC    ", "      CEC    ", "      CEC    ", "      CCC    ", "             ", "             ", "             ", "             ", "             ", "      FFF    ", "      FEF    ", "      FEF    ", "      FFF    ", "      AAA    ", "             ")
                    .aisle("             ", "             ", " K           ", "             ", "             ", "             ", "             ", "             ", "             ", "             ", "             ", "             ", "             ", "             ", "             ", "             ")
                    .where('A', blocks(GTOBlocks.PPS_CORROSION_RESISTANT_MECHANICAL_HOUSING.get()))
                    .where('B', blocks(GTOBlocks.CHEMICAL_CORROSION_RESISTANT_PIPE_CASING.get()))
                    .where('C', blocks(GTOBlocks.MANASTEEL_CASING.get()))
                    .where('D', blocks(GTOBlocks.IRIDIUM_PIPE_CASING.get()))
                    .where('E', blocks(RegistriesUtils.getBlock("botania:mana_glass")))
                    .where('F', blocks(GTOBlocks.ELEMENTIUM_CASING.get()))
                    .where('G', blocks(GTOBlocks.SOURCE_FIBER_MECHANICAL_CASING.get()))
                    .where('H', blocks(GTOBlocks.TRANSMUTATION_CATALYST.get()))
                    .where('I', blocks(GTOBlocks.HERETICAL_MECHANICAL_CASING.get()))
                    .where('J', blocks(GTOBlocks.AMPROSIUM_ACTIVE_CASING.get()))
                    .where('K', controller(definition))
                    .where(' ', any())
                    .build())
            .workableCasingRenderer(GTCEu.id("block/casings/gcym/corrosion_proof_casing"), GTCEu.id("block/multiblock/gcym/large_centrifuge"))
            .register();

    public static final MultiblockMachineDefinition LARGE_PERFUSION_DEVICE = multiblock("large_perfusion_device", "大型灌注装置", ManaMultiblockMachine::new)
            .nonYAxisRotation()
            .tooltipsText("多方块的魔源灌注装置", "Multi-block magic source infusion device")
            .parallelizableTooltips()
            .perfectOCTooltips()
            .parallelizableManaOverclock()
            .recipeTypes(GTORecipeTypes.INFUSER_CORE_RECIPES)
            .block(GTOBlocks.SOURCE_FIBER_MECHANICAL_CASING)
            .pattern(definition -> MultiBlockFileReader.start(definition)
                    .where('A', blocks(GTOBlocks.SPELL_PRISM_CASING.get()))
                    .where('B', blocks(GTOBlocks.SOURCE_FIBER_MECHANICAL_CASING.get())
                            .or(abilities(GTOPartAbility.INPUT_MANA).setMaxGlobalLimited(16, 1))
                            .or(abilities(PARALLEL_HATCH).setMaxGlobalLimited(1))
                            .or(abilities(EXPORT_ITEMS))
                            .or(abilities(IMPORT_ITEMS))
                            .or(abilities(IMPORT_FLUIDS)))
                    .where('C', blocks(GTOBlocks.INFUSED_GOLD_CASING.get()))
                    .where('D', blocks(GTOBlocks.SOURCE_STONE_CASING.get()))
                    .where('E', blocks(GTOBlocks.SOURCE_FIBER_MECHANICAL_CASING.get()))
                    .where('F', blocks(GTOBlocks.INFUSED_GOLD_REINFORCED_WOODEN_CASING.get()))
                    .where('G', blocks(RegistriesUtils.getBlock("ars_nouveau:magebloom_block")))
                    .where('H', controller(definition))
                    .where(' ', any())
                    .build())
            .workableCasingRenderer(GTOCore.id("block/casings/source_fiber_mechanical_casing"), GTCEu.id("block/multiblock/gcym/large_centrifuge"))
            .register();

    public static final MultiblockMachineDefinition THE_PRIMORDIAL_RECONSTRUCTOR = multiblock("the_primordial_reconstructor", "源初重构仪", ThePrimordialReconstructor::new)
            .nonYAxisRotation()
            .tooltips(GTOMachineTooltips.INSTANCE.getThePrimordialReconstructorTooltips().getSupplier())
            .recipeTypes(GTRecipeTypes.DUMMY_RECIPES)
            .block(GTOBlocks.SPELL_PRISM_CASING)
            .pattern(definition -> FactoryBlockPattern.start(definition)
                    .aisle("  A   A  ", "  A   A  ", "   ABA   ", "  A   A  ", "  A   A  ", "         ", "  C   C  ", "         ", "  A   A  ", "  A   A  ", "   ABA   ", "  A   A  ", "  A   A  ")
                    .aisle("  D   D  ", " EEDDDEE ", "  EAFAE  ", " GGGGGGG ", "         ", "         ", "         ", "         ", "         ", " GGGGGGG ", "  EAFAE  ", " EEDDDEE ", "  D   D  ")
                    .aisle("ADD   DDA", "AEHAIAHEA", " EFAFAFE ", "AGFAJAFGA", "A FA AF A", "  F   F  ", "C B   B C", "  F   F  ", "A FA AF A", "AGFAJAFGA", " EFAFAFE ", "AEHAIAHEA", "ADD   DDA")
                    .aisle("   DID   ", " DAAKAAD ", "AAALFLAAA", " GAMJMAG ", "  A   A  ", "         ", "         ", "         ", "  A   A  ", " GAMJMAG ", "AAALFLAAA", " DAAKAAD ", "   DID   ")
                    .aisle("   III   ", " DIKNKID ", "BFFFOFFFB", " GJJNJJG ", "    C    ", "    C    ", "    C    ", "    C    ", "    C    ", " GJJNJJG ", "BFFFOFFFB", " DIKNKID ", "   III   ")
                    .aisle("   DID   ", " DAAKAAD ", "AAALFLAAA", " GAMJMAG ", "  A   A  ", "         ", "         ", "         ", "  A   A  ", " GAMJMAG ", "AAALFLAAA", " DAAKAAD ", "   DID   ")
                    .aisle("ADD   DDA", "AEHAIAHEA", " EFAFAFE ", "AGFAJAFGA", "A FA AF A", "  F   F  ", "C B   B C", "  F   F  ", "A FA AF A", "AGFAJAFGA", " EFAFAFE ", "AEHAIAHEA", "ADD   DDA")
                    .aisle("  D   D  ", " EEDDDEE ", "  EAFAE  ", " GGGPGGG ", "         ", "         ", "         ", "         ", "         ", " GGGGGGG ", "  EAFAE  ", " EEDDDEE ", "  D   D  ")
                    .aisle("  A   A  ", "  A   A  ", "   ABA   ", "  A   A  ", "  A   A  ", "         ", "  C   C  ", "         ", "  A   A  ", "  A   A  ", "   ABA   ", "  A   A  ", "  A   A  ")
                    .where('A', blocks(GTOBlocks.SOURCE_FIBER_MECHANICAL_CASING.get()))
                    .where('B', blocks(ChemicalHelper.getBlock(TagPrefix.frameGt, GTOMaterials.Thaumium)))
                    .where('C', blocks(RegistriesUtils.getBlock("botania:bifrost_perm")))
                    .where('D', blocks(GTOBlocks.SOURCE_STONE_CASING.get()))
                    .where('E', blocks(GTOBlocks.SPELL_PRISM_CASING.get()))
                    .where('F', blocks(GTOBlocks.HERETICAL_MECHANICAL_CASING.get()))
                    .where('G', blocks(GTOBlocks.SPELL_PRISM_CASING.get())
                            .or(abilities(INPUT_ENERGY))
                            .or(abilities(GTOPartAbility.INPUT_MANA))
                            .or(abilities(IMPORT_FLUIDS))
                            .or(abilities(IMPORT_ITEMS))
                            .or(abilities(EXPORT_FLUIDS))
                            .or(abilities(EXPORT_ITEMS)))
                    .where('H', blocks(ChemicalHelper.getBlock(TagPrefix.block, Runerock)))
                    .where('I', blocks(ChemicalHelper.getBlock(TagPrefix.frameGt, GTOMaterials.Laureril)))
                    .where('J', blocks(ChemicalHelper.getBlock(TagPrefix.frameGt, GTOMaterials.Gaia)))
                    .where('K', blocks(RegistriesUtils.getBlock("botania:conjuration_catalyst")))
                    .where('L', blocks(RegistriesUtils.getBlock("botania:alchemy_catalyst")))
                    .where('M', blocks(RegistriesUtils.getBlock("botania:elf_glass")))
                    .where('N', blocks(RegistriesUtils.getBlock("extrabotany:dimension_catalyst")))
                    .where('J', blocks(GTOBlocks.STAR_STONE[0].get()))
                    .where('P', controller(definition))
                    .where(' ', any())
                    .build())
            .workableCasingRenderer(GTOCore.id("block/casings/spell_prism_casing"), GTCEu.id("block/multiblock/fusion_reactor"))
            .register();

    public static final MultiblockMachineDefinition RESONANCE_FLOWER = multiblock("resonance_flower", "共鸣之花", ResonanceFlowerMachine::new)
            .tooltips(GTOMachineTooltips.INSTANCE.getResonanceFlowerTooltips().getSupplier())
            .parallelizableTooltips()
            .parallelizableManaOverclock()
            .recipeTypes(GTORecipeTypes.ELEMENTAL_RESONANCE)
            .block(GTOBlocks.THE_ORIGIN_CASING)
            .pattern(definition -> MultiBlockFileReader.start(definition, RelativeDirection.FRONT, RelativeDirection.UP, RelativeDirection.RIGHT)
                    .where('A', blocks(GTOBlocks.THE_END_CASING.get()))
                    .where('B', blocks(GTOBlocks.SPELL_PRISM_CASING.get()))
                    .where('C', blocks(RegistriesUtils.getBlock("ars_nouveau:spell_prism")))
                    .where('D', blocks(RegistriesUtils.getBlock("botania:elf_glass")))
                    .where('E', blocks(RegistriesUtils.getBlock("ars_nouveau:source_gem_block")))
                    .where('F', blocks(GTOBlocks.SOURCE_STONE_CASING.get()))
                    .where('G', blocks(GTOBlocks.THE_CHAOS_CASING.get()))
                    .where('H', blocks(RegistriesUtils.getBlock("botania:mana_diamond_block")))
                    .where('I', blocks(GTOBlocks.TERRASTEEL_CASING.get()))
                    .where('J', blocks(GTOBlocks.ORIGINAL_BRONZE_CASING.get()))
                    .where('K', blocks(GTOBlocks.THE_ORIGIN_CASING.get()))
                    .where('L', blocks(RegistriesUtils.getBlock("ars_nouveau:void_prism")))
                    .where('M', blocks(GTOBlocks.THE_ORIGIN_CASING.get())
                            .or(autoAbilities(definition.getRecipeTypes()))
                            .or(abilities(GTOPartAbility.INPUT_MANA).setMaxGlobalLimited(16))
                            .or(abilities(MAINTENANCE).setExactLimit(1)))
                    .where('N', blocks(RegistriesUtils.getBlock("botania:dragonstone_block")))
                    .where('O', blocks(RegistriesUtils.getBlock("botania:bifrost_perm")))
                    .where('P', controller(definition))
                    .where(' ', any())
                    .build())
            .workableCasingRenderer(GTOCore.id("block/casings/the_origin_casing"), GTCEu.id("block/multiblock/gcym/large_centrifuge"))
            .register();
}
